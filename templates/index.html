<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ Thống Phân Loại Hoa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2E7D32;
            --bg: #f6f7fb;
            --card: #ffffff;
            --text: #222;
            --muted: #666;
            --radius: 10px;
        }

        body {
            font-family: system-ui, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: auto;
        }

        h1 {
            text-align: center;
            color: var(--primary);
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            background: #eee;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            border-radius: var(--radius);
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary);
        }

        video, img {
            max-width: 100%;
            border-radius: var(--radius);
        }

        .btn {
            margin-top: 15px;
            padding: 12px 25px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: #c62828;
            color: white;
        }

        .btn-secondary {
            background: #eee;
        }

        .result {
            margin-top: 25px;
            padding: 20px;
            border-left: 5px solid var(--primary);
            animation: fade 0.4s ease;
        }

        .confidence-bar {
            background: #ddd;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .confidence-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.8s ease;
        }

        .hidden {
            display: none;
        }

        @keyframes fade {
            from {opacity: 0; transform: translateY(10px);}
            to {opacity: 1;}
        }
    </style>
</head>

<body>
<div class="container">

    <h1><i class="fas fa-seedling"></i> Phân Loại Hoa (AI)</h1>

    <!-- FORM gửi về Flask -->
    <form id="predict-form" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" id="hidden-file" hidden>
        <input type="hidden" name="webcam_image" id="hidden-webcam">
    </form>

    <div class="card">
        <div class="tabs">
            <button class="tab active" data-tab="upload">Tải Ảnh</button>
            <button class="tab" data-tab="webcam">Webcam</button>
        </div>

        <!-- UPLOAD -->
        <div id="upload" class="tab-content active">
            <div class="upload-area" id="upload-area">
                <i class="fas fa-cloud-upload-alt fa-3x"></i>
                <p>Click hoặc kéo ảnh vào đây</p>
                <input type="file" id="file-input" accept="image/*" hidden>
            </div>

            <img id="image-preview" class="hidden">
        </div>

        <!-- WEBCAM -->
        <div id="webcam" class="tab-content">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" hidden></canvas>

            <div>
                <button class="btn btn-primary" id="start">Bật Webcam</button>
                <button class="btn btn-secondary" id="capture" disabled>Chụp</button>
                <button class="btn btn-danger" id="stop" disabled>Tắt</button>
            </div>

            <img id="webcam-preview" class="hidden">
        </div>

        <button class="btn btn-primary" id="predict" disabled>
            <i class="fas fa-search"></i> Phân Loại
        </button>
    </div>

    {% if prediction %}
    <div class="card result">
        <h2>Kết quả</h2>
        <p><strong>Loài hoa:</strong> {{ prediction }}</p>
        <p><strong>Độ tin cậy:</strong> {{ (confidence*100)|round(2) }}%</p>

        <div class="confidence-bar">
            <div class="confidence-fill" data-value="{{ (confidence*100)|round(2) }}"></div>
        </div>
    </div>
    {% endif %}

</div>

<script>
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');

    let currentTab = "upload";
    let currentImage = null;
    let stream = null;

    tabs.forEach(tab => {
        tab.onclick = () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            contents.forEach(c => c.classList.remove('active'));
            document.getElementById(tab.dataset.tab).classList.add('active');

            currentTab = tab.dataset.tab;
            updateButton();
        };
    });

    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const imgPreview = document.getElementById('image-preview');
    const predictBtn = document.getElementById('predict');

    uploadArea.onclick = () => fileInput.click();

    fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            currentImage = e.target.result;
            imgPreview.src = currentImage;
            imgPreview.classList.remove('hidden');
            updateButton();
        };
        reader.readAsDataURL(file);
    };

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const webcamImg = document.getElementById('webcam-preview');

    document.getElementById('start').onclick = async () => {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        document.getElementById('capture').disabled = false;
        document.getElementById('stop').disabled = false;
    };

    document.getElementById('capture').onclick = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        currentImage = canvas.toDataURL("image/jpeg");
        webcamImg.src = currentImage;
        webcamImg.classList.remove('hidden');
        updateButton();
    };

    document.getElementById('stop').onclick = () => {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    };

    function updateButton() {
        predictBtn.disabled = !currentImage;
    }

    predictBtn.onclick = () => {
        const form = document.getElementById('predict-form');
        const hiddenFile = document.getElementById('hidden-file');
        const hiddenWebcam = document.getElementById('hidden-webcam');

        if (currentTab === "upload") {
            fetch(currentImage)
                .then(r => r.blob())
                .then(b => {
                    const f = new File([b], "image.jpg", {type: "image/jpeg"});
                    const dt = new DataTransfer();
                    dt.items.add(f);
                    hiddenFile.files = dt.files;
                    hiddenWebcam.value = "";
                    form.submit();
                });
        } else {
            hiddenWebcam.value = currentImage;
            hiddenFile.value = "";
            form.submit();
        }
    };

    // animate confidence
    const bar = document.querySelector('.confidence-fill');
    if (bar) {
        setTimeout(() => {
            bar.style.width = bar.dataset.value + "%";
        }, 200);
    }
</script>

</body>
</html>
